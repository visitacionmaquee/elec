name: Image Processing CI/CD Pipeline

on:
  push:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/**'
      - 'input/**'
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
  workflow_dispatch:  # Manual trigger

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install system dependencies for OpenCV
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-glx libglib2.0-0
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: Run tests with pytest
      run: |
        python -m pytest tests/ -v --cov=src --cov-report=xml --cov-report=html
        
    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          test-reports/
          coverage.xml

  process-images:
    needs: test
    if: github.event_name == 'push' && contains(github.event.head_commit.message, 'input/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-glx libglib2.0-0
        pip install -r requirements.txt
        
    - name: Detect changed images
      id: changed-images
      run: |
        # Get list of changed files in input directory
        git diff --name-only HEAD^ HEAD | grep "^input/" > changed_files.txt || true
        
        if [ -s changed_files.txt ]; then
          echo "images=$(cat changed_files.txt | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Process images with all filters
      if: steps.changed-images.outputs.has_changes == 'true'
      run: |
        # Create output directory
        mkdir -p output
        
        # Split image list
        IFS=',' read -ra IMAGES <<< "${{ steps.changed-images.outputs.images }}"
        
        for image_path in "${IMAGES[@]}"; do
          if [ -f "$image_path" ]; then
            filename=$(basename "$image_path")
            echo "Processing: $filename"
            
            # Run each processing script
            python src/beautify_final.py <<< "$filename" || echo "Beautify failed for $filename"
            python src/brighten_final.py <<< "$filename" || echo "Brighten failed for $filename"
            python src/cartoonify_final.py <<< "$filename" || echo "Cartoonify failed for $filename"
            python src/slowshutter_final.py <<< "$filename" || echo "Slowshutter failed for $filename"
            
            # For CandidOrPosed, we need to handle differently
            python -c "
import sys
sys.path.append('src')
import CandidOrPosed
CandidOrPosed.classify_image('$image_path')
" || echo "Candid detection failed for $filename"
          fi
        done
        
    - name: Commit and push processed images
      if: steps.changed-images.outputs.has_changes == 'true'
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add processed images
        if [ -n "$(git status --porcelain output/)" ]; then
          git add output/
          git commit -m "CI: Auto-process images from input [skip ci]"
          git push
        else
          echo "No new processed images to commit"
        fi
        
    - name: Upload processed images as artifact
      if: steps.changed-images.outputs.has_changes == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: processed-images
        path: output/
        
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Run safety check
      uses: pyupio/safety-action@v1
      with:
        api-key: ${{ secrets.SAFETY_API_KEY }}
        
    - name: Run bandit security scan
      run: |
        pip install bandit
        bandit -r src/ -f html -o security-report.html || true
        
    - name: Upload security report
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: security-report.html
