# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
    paths:
      - 'input/**'
      - 'src/**'
      - 'test/**'
      - 'requirements.txt'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run tests with pytest
      run: |
        python -m pytest test/ -v --cov=src --cov-report=xml
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        
  process-images:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.event.head_commit.message, 'input/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Detect changed images
      id: changed-images
      run: |
        # Get list of changed files in input directory
        git diff --name-only HEAD^ HEAD -- input/ > changed_files.txt || true
        
        if [ -s changed_files.txt ]; then
          echo "Changed images detected:"
          cat changed_files.txt
          echo "images=$(cat changed_files.txt | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
        else
          echo "No images changed in input directory"
          echo "images=" >> $GITHUB_OUTPUT
        fi
        
    - name: Process images
      if: steps.changed-images.outputs.images != ''
      run: |
        echo "Processing images: ${{ steps.changed-images.outputs.images }}"
        
        # Create output directory if it doesn't exist
        mkdir -p output
        
        # Process each image with all filters
        IFS=',' read -ra IMAGES <<< "${{ steps.changed-images.outputs.images }}"
        
        for image_path in "${IMAGES[@]}"; do
          if [ -f "$image_path" ]; then
            filename=$(basename "$image_path")
            echo "Processing: $filename"
            
            # Run each processing script
            python -c "
import sys
sys.path.append('src')
import cv2
import numpy as np

# Load image
img = cv2.imread('$image_path')
if img is not None:
    # Beautify
    exec(open('src/beautify_final.py').read())
    beautified = smooth_skin(img)
    cv2.imwrite(f'output/beautified_{filename}', beautified)
    
    # Brighten
    exec(open('src/brighten_final.py').read())
    brightened = apply_clahe(img)
    cv2.imwrite(f'output/brightened_{filename}', brightened)
    
    # Cartoonify
    exec(open('src/cartoonify_final.py').read())
    cartoonified = cartoonify(img)
    cv2.imwrite(f'output/cartoonified_{filename}', cartoonified)
    
    # Slow shutter
    exec(open('src/slowshutter_final.py').read())
    slow_shutter = apply_slow_shutter(img)
    cv2.imwrite(f'output/slowshutter_{filename}', slow_shutter)
    
    print(f'Processed {filename} with all filters')
else:
    print(f'Failed to load {filename}')
            "
          fi
        done
        
    - name: Commit and push processed images
      if: steps.changed-images.outputs.images != ''
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add processed images
        if [ -d "output" ]; then
          git add output/
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "CI: Auto-process images from input folder [skip ci]"
            git push
          fi
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
